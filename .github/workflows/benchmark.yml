name: Ruby Setup Benchmark

on:
  workflow_dispatch:

env:
  BORINGCACHE_API_TOKEN: ${{ secrets.BORINGCACHE_API_TOKEN }}

jobs:
  # Baseline: ruby/setup-ruby with actions/cache
  ruby-actions-cache:
    name: "Baseline: actions/cache"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        run: [1, 2, 3]
    steps:
      - uses: actions/checkout@v4
        with:
          repository: boringcache/action
          path: boringcache-action

      - name: Setup Ruby with bundler cache
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: false

      - name: Cache gems (actions/cache)
        uses: actions/cache@v4
        with:
          path: boringcache-action/examples/rails_app/vendor/bundle
          key: gems-benchmark-${{ runner.os }}-${{ hashFiles('boringcache-action/examples/rails_app/Gemfile.lock') }}
          restore-keys: gems-benchmark-${{ runner.os }}-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libyaml-dev libsqlite3-dev libvips42 pkg-config

      - name: Bundle install
        run: |
          cd boringcache-action/examples/rails_app
          bundle config path vendor/bundle
          START_TIME=$(date +%s%N)
          bundle install --jobs 4 --retry 3
          END_TIME=$(date +%s%N)
          DURATION=$(( (END_TIME - START_TIME) / 1000000 ))
          echo "actions/cache bundle install - Run ${{ matrix.run }}: ${DURATION}ms"
          mkdir -p benchmark-results
          echo "${DURATION}" > benchmark-results/actions-cache-run${{ matrix.run }}.txt

      - uses: actions/upload-artifact@v4
        with:
          name: actions-cache-results-${{ matrix.run }}
          path: benchmark-results/

  # Test: boringcache/ruby action
  ruby-boringcache:
    name: "Test: boringcache/ruby"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        run: [1, 2, 3]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/checkout@v4
        with:
          repository: boringcache/action
          path: boringcache-action

      - name: Setup Ruby with boringcache
        uses: ./
        with:
          workspace: boringcache/actions
          ruby-version: "3.3"
          working-directory: boringcache-action/examples/rails_app
          exclude: "*.out"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libyaml-dev libsqlite3-dev libvips42 pkg-config

      - name: Bundle install
        run: |
          cd boringcache-action/examples/rails_app
          bundle config path vendor/bundle
          START_TIME=$(date +%s%N)
          bundle install --jobs 4 --retry 3
          END_TIME=$(date +%s%N)
          DURATION=$(( (END_TIME - START_TIME) / 1000000 ))
          echo "boringcache/ruby bundle install - Run ${{ matrix.run }}: ${DURATION}ms"
          mkdir -p benchmark-results
          echo "${DURATION}" > benchmark-results/boringcache-run${{ matrix.run }}.txt

      - uses: actions/upload-artifact@v4
        with:
          name: boringcache-results-${{ matrix.run }}
          path: benchmark-results/

  benchmark-summary:
    name: Generate Summary
    runs-on: ubuntu-latest
    needs: [ruby-actions-cache, ruby-boringcache]
    if: always()
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: "*-results-*"
          merge-multiple: true

      - name: Generate summary
        run: |
          echo "# Ruby Setup Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Bundle Install Times (Rails app)" >> $GITHUB_STEP_SUMMARY
          echo "| Run | ruby/setup-ruby + actions/cache | boringcache/ruby | Improvement |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------------------------------|------------------|-------------|" >> $GITHUB_STEP_SUMMARY

          for run in 1 2 3; do
            if [[ -f "actions-cache-run${run}.txt" && -f "boringcache-run${run}.txt" ]]; then
              a=$(cat "actions-cache-run${run}.txt")
              b=$(cat "boringcache-run${run}.txt")
              if [[ $b -gt 0 ]]; then
                imp=$(echo "scale=2; $a / $b" | bc -l)
              else
                imp="N/A"
              fi
              echo "| $run | ${a}ms | ${b}ms | ${imp}x |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $run | Missing | Missing | N/A |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Summary" >> $GITHUB_STEP_SUMMARY

          if [[ -f actions-cache-run1.txt && -f actions-cache-run2.txt && -f actions-cache-run3.txt && \
                -f boringcache-run1.txt && -f boringcache-run2.txt && -f boringcache-run3.txt ]]; then
            aa=$(( ($(cat actions-cache-run1.txt)+$(cat actions-cache-run2.txt)+$(cat actions-cache-run3.txt))/3 ))
            bb=$(( ($(cat boringcache-run1.txt)+$(cat boringcache-run2.txt)+$(cat boringcache-run3.txt))/3 ))
            if [[ $bb -gt 0 ]]; then
              imp=$(echo "scale=2; $aa / $bb" | bc -l)
            else
              imp="N/A"
            fi
            echo "- **ruby/setup-ruby + actions/cache average**: ${aa}ms" >> $GITHUB_STEP_SUMMARY
            echo "- **boringcache/ruby average**: ${bb}ms" >> $GITHUB_STEP_SUMMARY
            echo "- **Improvement**: ${imp}x" >> $GITHUB_STEP_SUMMARY
          fi
